# Incident Disclosure 2025-05-08
## Summary
During the off-boarding of a former strategist, several issues were discovered affecting strategies which the strategist was responsible for:
- The strategist deployed several versions of APR Oracles meant to inflate the reported APR on the USDS Sky Compounder. This mainly impacted projected APYs reported in the UI, and to a lesser extent debt allocations on the yvUSDS-1 vault. A corrected version [[1]](#References) of this APR oracle was deployed and set on the central APR oracle.
- The strategist refused to transfer the `management` role of strategies where his EOA held this role. In response, new versions of these strategies were deployed with Yearn's strategist multisig (SMS) as `management`. 
- Most impacted strategies only had deposits from other Yearn V3 vaults, making the issue easy to correct. However, the USDS Sky Compounder had direct user deposits, so a migration has been made available in the Yearn UI.
- No user funds funds were ever at risk thanks to Yearn V3’s design and permissioning. Nonetheless, remaining depositors in the now deprecated USDS Sky Compounder [[2]](#References) are encouraged to migrate to the new version via the UI [[3]](#References).

## Background
- Yearn V3 tokenized strategies can accept direct deposits. Users can choose to deposit to a single strategy (such as the USDS Sky Compounder) or to a V3 allocator vault (such as yvUSDS-1)  that allocates to multiple strategies (similarly to V2 vaults).
- V3 strategies are designed to be as immutable as possible. They are non-upgradeable, and the `management` role can never touch user principal. At most, `management` handles selling of earned reward tokens into profits, and can tweak minor parameters such as profit unlock time. Since `management` also receives performance fees on profits earned, they are motivated to properly operate a strategy with user funds in it to earn a share of profits.
- Thus, if `management` cannot touch user principal, and is incentivized to efficiently turn rewards into profit, trust needed in `management` is minimal. This was one of the guiding principals and part of the vision behind Yearn V3—anyone could deploy and operate a strategy because of the protections offered by limiting the actions `management` could take.
- Additionally, `management` (along with the SMS) has the power to set a strategy's APR oracle on Yearn's central APR oracle [[4]](#References). APR oracles are used to provide the UI with forward-looking strategy APRs and to optimize allocations for maximum APR for Yearn's V3 allocator vaults, such as yvUSDS-1 [[5]](#References).
- For most strategies, the `management` role points to a committee multisig. A committee is a group of strategists who share specialized knowledge about a given protocol/strategy group. Committees were created in 2021 as a part of Yearn V2 to ensure redundancy of knowledge, specialization, and availability, among other benefits. Though committees were not required for V3 strategies, they were highly encouraged.

## Details of Incident
### APR Oracle
- During a review of strategies on which the former strategist was `management`, it was flagged that the APR oracle for the previous USDC Sky Compounder was changed several times since deployment.
    - Importantly, unless an additional type of rewards is added to a protocol or a bug is discovered in the APR logic, it is highly unusual for an APR oracle to need to be updated after deployment.
- A closer inspection revealed that seven different APR oracles had been used by this strategy over the six months it had been operating.
    - Although the initially reviewed and deployed APR oracle [[6]](#References) correctly reported the APR of SKY rewards for staking USDS, subsequent versions reported APY instead of APR [[7]](#References), and directly added up to 1% to the returned value [[8]](#References). For later versions this added value was hidden in assembly code [[9]](#References).
- Because `management` was an EOA, these updates were able to happen without the knowledge of any other strategists, and the artificial bump in reported APR was small enough to not raise suspicion.
- Theoretically, a malicious oracle that reports inflated APRs will receive more vault debt than it deserves, driving more fees to the strategist who deployed it. However, review of corrected historical APR oracle data, as well as APR data from other strategies, showed that in reality, allocations were minimally impacted. The best APR on USDS for most of the past 6 months, outside of short-lived spikes on Aave or Compound, was from staking for SKY rewards—meaning that the manipulated oracle needlessly increased APR for a strategy that usually had the highest APR anyway.
    - On more than 75% of days in the past 6 months, the USDS Sky Compounder had the highest spot APR, even when simulating sending the entire vault TVL to the strategy. This number approaches 90% when simulating sending significant TVL (25% of vault total assets) into any competing strategy.

### Strategy Migrations
- As a part of offboarding, it was requested that the strategist transfer `management` of several strategies from his EOA to Yearn's SMS. Though most strategies have `management` assigned to a committee multisig, these strategies were not assigned to committees.
- When the strategist failed to respond to several requests to transfer `management`, new versions of the strategies were deployed.

## Details of Fix
- New versions of affected strategies were deployed and attached to vaults, prior versions were revoked, and allocator vault funds were migrated to the new strategies. As the USDS Sky Compounder was the only strategy with significant direct user deposits, a migration was posted in Yearn's UI, with no fees on the new version for the first 60 days to incentivize migration [[3]](#References). Though user funds remain safe in the old version, to ensure regular compounding of rewards, users are encouraged to migrate. As of writing, over 80% of TVL from direct deposits has already migrated.
- A new version of the USDS Sky Compounder APR oracle with correct calculations was deployed and set for use on the new strategy [[1]](#References).
- `management` role on all strategies hosted on Yearn's frontend will be required to be at least a 2/3 multisig made up of current strategists or set to the SMS. This will ensure continuity for direct depositors and minimize the chances of a similar scenario happening in the future.
- Since `management` also sets APR oracles, this will prevent future undetected changes to APR oracles after deployment that may misreport APR.

## Oracle Change Timeline & Analysis

The APR oracle for the prior USDS Sky Compounder was updated many times, with a total of 7 distinct versions.

### Timeline

| Date of Update | Oracle Address | Manipulation Type |
| :--- | :--- | :--- |
| 2024-10-12 | [0x5853a86...](https://etherscan.io/address/0x5853a86029e6127f2c60a69365dc7274b796bc32) | **Correct (Simple APR)** |
| 2024-10-23 | [0x1f849aa...](https://etherscan.io/address/0x1f849aa689f0276324661ab9d136e86a8215a948) | Flawed (continuous) APY calculation |
| 2024-10-24 | [0x5853a86...](https://etherscan.io/address/0x5853a86029e6127f2c60a69365dc7274b796bc32) | **Correct (Simple APR)** |
| 2024-11-18 | [0x184c0c1...](https://etherscan.io/address/0x184c0c17a05383910207ce0e60879066a650f282) | Reports APY instead of APR |
| 2025-01-20 | [0xf041528...](https://etherscan.io/address/0xf041528986db672044dc584a0ced65484cf70713) | APY + 1% hardcoded boost |
| 2025-01-29 | [0x184c0c1...](https://etherscan.io/address/0x184c0c17a05383910207ce0e60879066a650f282) | Reports APY instead of APR |
| 2025-02-26 | [0xf041528...](https://etherscan.io/address/0xf041528986db672044dc584a0ced65484cf70713) | APY + 1% hardcoded boost |
| 2025-02-27 | [0x184c0c1...](https://etherscan.io/address/0x184c0c17a05383910207ce0e60879066a650f282) | Reports APY instead of APR |
| 2025-03-13 | [0x3102b0b...](https://etherscan.io/address/0x3102b0b4d99e2147f3ea0e64ebad19c2b432e2f3) | APY + 0.5% hidden boost in assembly |
| 2025-03-15 | [0x37da60b...](https://etherscan.io/address/0x37da60b41f786075590d48d961e377f3e3c9673d) | APY + 1% hidden boost in assembly |
| 2025-03-17 | [0x3102b0b...](https://etherscan.io/address/0x3102b0b4d99e2147f3ea0e64ebad19c2b432e2f3) | APY + 0.5% hidden boost in assembly |
| 2025-03-25 | [0x184c0c1...](https://etherscan.io/address/0x184c0c17a05383910207ce0e60879066a650f282) | Reports APY instead of APR |
| 2025-04-02 | [0xc9dbd5c...](https://etherscan.io/address/0xc9dbd5c98240cba8674dd00e3d3c7737c97186da) | APY + 0.25% hidden boost in assembly |
| 2025-05-20 | [0x37da60b...](https://etherscan.io/address/0x37da60b41f786075590d48d961e377f3e3c9673d) | APY + 1% hidden boost in assembly |


### Analysis of Each Oracle Contract

#### 1. [0x5853a86029e6127f2c60a69365dc7274b796bc32](https://etherscan.io/address/0x5853a86029e6127f2c60a69365dc7274b796bc32)
*   **Manipulation**: None
*   **Analysis:** This is the original, legitimate APR oracle. It calculates a simple, non-compounding Annual Percentage Rate.
*   **Proof:** The calculation is a straightforward `(annual rewards / total supply)`.

```solidity
function aprAfterDebtChange(/*...*/) external view override returns (uint256) {
    // ...
    uint256 apr = rewardRate * secondsPerYear * price * WAD / totalSupply / WAD;
    return apr;
}
```

---

#### 2. [0x1f849aa689f0276324661ab9d136e86a8215a948](https://etherscan.io/address/0x1f849aa689f0276324661ab9d136e86a8215a948)
*   **Manipulation**: Continously compounding APY
*   **Analysis:** This version of APY assumes continuous compounding in converting APR to APY. The use of continuous compounding and `rpow` likely come from MakerDAO's DSR/sDAI code.
*   **Proof:** The [sDAI](https://etherscan.io/token/0x83F20F44975D03b1b09e64809B757c47f942BEeA#code#L122) code as well as DSR modules like [Pot.sol](https://github.com/sky-ecosystem/dss/blob/master/src/pot.sol) contain matches for the `rpow` code with continuous compounding.

```solidity
function aprAfterDebtChange(/*...*/) external view override returns (uint256) {
    // ...
    uint256 rate = rewardRate * price * WAD / totalSupply / WAD; 
    // This `rate` is calculated incorrectly for the APY formula that follows.
    return (rpow(rate + WAD, secondsPerYear, WAD) - WAD) + 1;
}
```

---

#### 3. [0x184c0c17a05383910207ce0e60879066a650f282](https://etherscan.io/address/0x184c0c17a05383910207ce0e60879066a650f282)
*   **Manipulation**: APY instead of APR
*   **Analysis:** The code correctly calculates APY (compounding yield) by determining a periodic rate and using exponentiation (`rpow`). Since APY is always higher than APR (and what the oracle is supposed to report), this is deceptive.
*   **Proof:** The formula is now `(1 + periodic_rate) ^ periods_per_year - 1`, the definition of APY.

```solidity
function aprAfterDebtChange(/*...*/) external view override returns (uint256) {
    // ...
    uint256 rate = rewardRate * profitMaxUnlockTime * price * WAD / totalSupply / WAD;
    return (rpow(rate + WAD, secondsPerYear / profitMaxUnlockTime, WAD) - WAD) + 1;
}
```

---

#### 4. [0xf041528986db672044dc584a0ced65484cf70713](https://etherscan.io/address/0xf041528986db672044dc584a0ced65484cf70713)
*   **Manipulation**: APY + 1% Boost
*   **Analysis:** This version takes the APY calculation from the previous version and adds a hardcoded **1% boost** to the final result.
*   **Proof:** The final `return` statement adds `1e16`. Since `1e18` is 100%, `1e16` is exactly 1%.

```solidity
function aprAfterDebtChange(/*...*/) external view override returns (uint256) {
    // ...
    uint256 rate = /* ... APY calculation ... */;
    return (rpow(rate + WAD, secondsPerYear / profitMaxUnlockTime, WAD) - WAD) + 1e16; // <-- 1% boost
}
```

---

#### 5. [0x3102b0b4d99e2147f3ea0e64ebad19c2b432e2f3](https://etherscan.io/address/0x3102b0b4d99e2147f3ea0e64ebad19c2b432e2f3)
*   **Manipulation**: APY + Hidden 0.5% Boost
*   **Analysis:** This version begins a deliberate trend of obfuscation. The strategist moved the hardcoded boost from the visible Solidity code into the `rpow` function's assembly block, making it much harder to spot during a casual review.
*   **Proof:** The assembly adds `base / 200`, which is `1e18 / 200` = `5e15` (0.5%).
```solidity
function rpow(/*...*/) internal pure returns (uint z) {
    assembly {
        // ... rpow logic ...
        z := add(z, div(base, 200)) // <-- Hidden 0.5% boost
    }
}
```

#### 6. [0x37da60b41f786075590d48d961e377f3e3c9673d](https://etherscan.io/address/0x37da60b41f786075590d48d961e377f3e3c9673d)
*   **Manipulation**: APY + Hidden 1% Boost
*   **Analysis:** This is the same code as before, with the simple change to the number hidden in the assembly code.
*   **Proof:** The assembly adds `base / 100`, which is `1e18 / 100` = `1e16` (1%).
```solidity
function rpow(/*...*/) internal pure returns (uint z) {
    assembly {
        // ... rpow logic ...
        z := add(z, div(base, 100)) // <-- Hidden 1% boost
    }
}
```

#### 7. [0xc9dbd5c98240cba8674dd00e3d3c7737c97186da](https://etherscan.io/address/0xc9dbd5c98240cba8674dd00e3d3c7737c97186da)
*   **Manipulation**: APY + Hidden 0.25% Boost
*   **Analysis:** This is the same code as before, with the simple change to the number hidden in the assembly code.
*   **Proof:** The assembly adds `base / 400`, which is `1e18 / 400` = `2.5e15` (0.25%).
```solidity
function rpow(/*...*/) internal pure returns (uint z) {
    assembly {
        // ... rpow logic ...
        z := add(z, div(base, 400)) // <-- Hidden 0.25% boost
    }
}
```

## References

1. https://etherscan.io/address/0x83d04292b36433bf294a655a96864824fb19b785
2. https://etherscan.io/address/0x4ce9c93513dff543bc392870d57df8c04e89ba0a
3. https://yearn.fi/v3/1/0x4cE9c93513DfF543Bc392870d57dF8C04e89Ba0a
4. https://etherscan.io/address/0x1981ad9f44f2ea9add2dc4ad7d075c102c70af92
5. https://etherscan.io/address/0x182863131f9a4630ff9e27830d945b1413e347e8
6. https://etherscan.io/address/0x5853a86029e6127f2C60a69365Dc7274B796Bc32
7. https://etherscan.io/address/0x184c0C17a05383910207Ce0e60879066A650F282
8. https://etherscan.io/address/0xf041528986DB672044dC584A0CEd65484cF70713
9. https://etherscan.io/address/0x37Da60b41F786075590D48D961e377F3e3c9673d
